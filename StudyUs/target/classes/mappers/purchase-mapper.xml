<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="purchaseMapper">

	<resultMap type="Purchase" id="purchaseResultMap">
		<id property="puNo" column="PU_NO"></id>
		<result property="rnum" column="RNUM"></result>
		<result property="mbNo" column="MB_NO"></result>
		<result property="stNo" column="ST_NO"></result>
		<result property="stName" column="ST_NAME"></result>
		<result property="puInsertDate" column="PU_INSERTDATE"></result>
		<result property="maxPersonnel" column="ST_MAX_PERSONNEL"></result>
		<result property="puStatus" column="PU_STATUS"></result>
	</resultMap>
	
<!-- 	<select id="studyList" resultMap="purchaseResultMap">
		SELECT PU_NO, MB_NO, S.ST_NO, S.ST_NAME, S.ST_MAX_PERSONNEL FROM PURCHASE P
		JOIN STUDY S USING(MB_NO) WHERE MB_NO = #{mbNo}
	</select> -->
	
	<select id="selectListCount" parameterType="Purchase" resultType="_int">
		SELECT COUNT(*) FROM PURCHASE 
		WHERE PU_STATUS = 1
	</select>
	
	<select id="selectPurchaseList" resultMap="purchaseResultMap">
		SELECT ROW_NUMBER() OVER(ORDER BY PU_INSERTDATE) AS RNUM, 
		P.PU_NO, P.MB_NO, ST_NO, S.ST_NAME, M.MB_EMAIL, P.PU_INSERTDATE
		FROM PURCHASE P
		LEFT OUTER JOIN STUDY S USING(ST_NO) 
		LEFT OUTER JOIN MEMBER M ON P.MB_NO = M.MB_NO
		WHERE PU_STATUS = 1
		ORDER BY RNUM ASC
	</select>
	
	<insert id="insertPremium" parameterType="Purchase">
		<selectKey keyProperty="puNo" resultType="int" order="AFTER">
			select SEQ_PURCHASE.currval FROM DUAL
		</selectKey>
		INSERT INTO PURCHASE VALUES(
    	SEQ_PURCHASE.NEXTVAL, #{stNo}, #{mbNo}, DEFAULT, DEFAULT)
	</insert>
	
	<select id="selectOnePuByMbNo" resultMap="purchaseResultMap">
		SELECT ROW_NUMBER() OVER(ORDER BY PU_INSERTDATE) AS RNUM, P.PU_NO, P.MB_NO, ST_NO, S.ST_NAME, P.PU_INSERTDATE, P.PU_STATUS
		FROM PURCHASE P
		LEFT OUTER JOIN STUDY S USING(ST_NO)
		WHERE P.MB_NO = #{mbNo} AND P.PU_STATUS = 1
		ORDER BY RNUM ASC
	</select>
	
</mapper>